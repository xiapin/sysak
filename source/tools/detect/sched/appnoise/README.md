# 功能说明
基于eBPF实现的采集指定任务干扰源的工具。

appnoise监控的是任务在执行过程中，由于各种原因受到干扰、打断的信息。

# 采样数据

| 采集指标 | 描述 | 输出形式 |
| ---- | ---- | ---- |
| IRQ | 任务被中断行干扰的次数以及时间 | 直方图、详细的IRQ干扰次数以及时间 |
| SOFTIRQ | 任务被软中断干扰的次数以及时间  | 直方图、详细的SOFTIRQ干扰次数以及时间 |
| NMI | 任务被NMI事件干扰的次数以及事件 | 直方图 |
| 调度时延 | 任务的调度时延 | 直方图 |
| 睡眠时延 | 任务的睡眠时延 | 直方图 |
| 阻塞时延 | 任务的阻塞时延 | 直方图 |
| IO阻塞时延 | 任务的IO阻塞时延 | 直方图 |
| 系统调用 | 任务发起的系统调用 | 直方图、详细的系统调用次数及时间 |
| 跨NUMA访问 | 任务的跨NUMA访存情况 | 发生跨numa访问的次数 |


# 使用说明
```
sysak  appnoise [-p PID] [-t TID] [-T TOP] [TIMES] [INTERVAL]
  [TIMES] 单次监控持续时间 默认 99999999
  [INTERVAL] 监控次数 默认 99999999
  -p 监控任务的pid: 针对给定的pid执行监控采集信息。
  -t 监控任务的tid: 针对给定的tid执行监控采集信息。
  -T 打印干扰详细信息时，只打印TOP N个事件详细信息，默认为10。
```
# 使用举例
## 运行说明
下面的例子使用appnoise对进程1085进行监控，单次监控时间为30秒，监控次数为2次 ,打印干扰详细信息时，只打印TOP 20 个事件的详细信息。
```
$sudo sysak runqslower -p 1085 30 2 -T 20
```
## 输出说明
上面结果输出说明如下：
- 各个事件的总体时间次数直方图。
```
Tracing... Hit Ctrl-C to end.
16:18:43
irq
          us             : count    distribution
         0 -> 1          : 3        |***************                         |
         2 -> 3          : 8        |****************************************|
         4 -> 7          : 2        |**********                              |
          total          : 26      (us)

softirq
          us             : count    distribution
         0 -> 1          : 22       |*****************                       |
         2 -> 3          : 24       |*******************                     |
         4 -> 7          : 49       |****************************************|
         8 -> 15         : 43       |***********************************     |
        16 -> 31         : 1        |                                        |
          total          : 766     (us)

wait
          us             : count    distribution
         0 -> 1          : 428      |****************************************|
         2 -> 3          : 10       |                                        |
         4 -> 7          : 75       |*******                                 |
         8 -> 15         : 102      |*********                               |
        16 -> 31         : 217      |********************                    |
        32 -> 63         : 157      |**************                          |
        64 -> 127        : 117      |**********                              |
       128 -> 255        : 67       |******                                  |
       256 -> 511        : 50       |****                                    |
       512 -> 1023       : 10       |                                        |
      1024 <=            : 13       |*                                       |
          total          : 90728   (us)

sleep
          s              : count    distribution
         0 -> 1          : 1241     |****************************************|
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 1        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 1        |                                        |
          total          : 59      (s)

syscall
          us             : count    distribution
         0 -> 1          : 386      |************************                |
         2 -> 3          : 201      |************                            |
         4 -> 7          : 380      |***********************                 |
         8 -> 15         : 119      |*******                                 |
        16 -> 31         : 49       |***                                     |
        32 -> 63         : 52       |***                                     |
        64 -> 127        : 306      |*******************                     |
       128 -> 255        : 166      |**********                              |
       256 -> 511        : 53       |***                                     |
       512 -> 1023       : 14       |                                        |
      1024 <=            : 641      |****************************************|
          total          : 103517235(us)
```

- WAIT事件的详细信息，此处打印的结果是目标进程在就绪队列上等待执行的过程中，最后等待的一个线程。换句话说，即是目标进程前一个执行的进程。从左到右依次是进程名、PID、等待次数

```
进程名                   进程PID   等待次数
  \                       ｜       ｜
<TASK> -> CUR             PID    COUNT
swapper/1                   0      488
node                   390945      136
kworker/u4:0           428187       89
AliYunDun                1114       57
node                   390908       53
cat                    422607       45
kworker/u4:2           425016       42
rcu_sched                  13       31
AliYunDunUpdate          1064        7
tuned                     807        6
kworker/1:0            430018        5
AliSecGuard             11624        3
sshd                   390821        3
python                   2672        2
containerd               2277        2
ksoftirqd/1                20        1
kworker/0:4            419722        1
sssd_nss                  747        1
cat                    433546        1
node                   390995        1
```

- IRQ事件的详细信息，从左到右依次是IRQ名称、干扰次数、干扰时间。
```
中断名               干扰次数  干扰时间
  ｜                   ｜       ｜
IRQ                  COUNT  TOTAL(us)
virtio0-output.0     13     26        
```

- SOFTIRQ干扰的详细信息，从左到右依次是SOFTIRQ名称、干扰次数、干扰时间。
```
软中断名    干扰次数 干扰时间
   ｜         |       |
SOFTIRQ    COUNT  TOTAL(us) 
timer      6      42        
net_rx     13     38        
sched      67     461       
rcu        53     225       
```

- SYSCALL的详细信息，从左到右依次是SYSCALL名称、调用次数、消耗时间。
```
系统调用名               调用次数    消耗时间
    |                       \         \
SYSCALL                   COUNT    TOTAL(us)
migrate_pages               796 29783389
preadv                       12      275
getuid                       19      133
arch_prctl                    2       99
pselect6                      4       61
inotify_rm_watch             24       57
fanotify_init                 8       33
removexattr                  12       17
[unknown: 355]                4        8
getsockopt                   12        8
lstat                        15        8
setgroups                     1        2
```
