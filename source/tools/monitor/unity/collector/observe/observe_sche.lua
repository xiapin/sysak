---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wrp.
--- DateTime: 2023/7/4 19:37
---

require("common.class")
local unistd = require("posix.unistd")
local CvProto = require("collector.vproto")
local CobserveSche = class("observeSche",CvProto)

local pid = 1

function CobserveSche:_init_(proto, pffi, mnt, pFile)
    CvProto._init_(self, proto)
    self.pFile = mnt .. pFile
    self._fsche = "/proc/" .. pid .. "/schedstat"
end

function CprocStatm:proc(elapsed, lines)

    local heads = {"size", "resident", "shared", "text", "lib", "data", "dt"}
    local c = 0
    for line in io.lines(self._fstatm) do
        local vs = {}
        local data = self._ffi.new("var_long_t")
        assert(self._cffi.var_input_long(self._ffi.string(line), data) == 0)
        assert(data.no == 7)
        for i, k in ipairs(heads) do
            local cell = {
                name = k,
                value = tonumber(data.value[i - 1]),
            }
            c = c + 1
            vs[c] = cell
        end
        self:appendLine(self:_packProto("self_statm", nil, vs))
    end

    self:push(lines)
end

return CprocStatm
