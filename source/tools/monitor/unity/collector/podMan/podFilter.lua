---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by liaozhaoyan.
--- DateTime: 2023/3/28 11:27 PM
---

require("common.class")

local dirent = require("posix.dirent")
local unistd = require("posix.unistd")
local stat = require("posix.sys.stat")
local bit = require("bit")
local pystring = require("common.pystring")
local system = require("common.system")

local CpodFilter = class("podFiler")

local podFiler = "^kubepods%-*"
local dockerFilter = "^cri%-containerd%-*"

local function listSrc(path)
    local res = {}
    local files = dirent.files(path)
    local c = 1
    for f in files do
        if not pystring:startswith(f, ".") then
            res[c] = f
            c = c + 1
        end
    end
    return res
end

function CpodFilter:_init_(topDir)
    if unistd.access(topDir) then
        self._top = topDir
    else
        error("podFilter: cannot visit top dir " .. topDir)
    end
end

local function addDirs(dirs, path)
    if not system:valueIsIn(dirs, path) then
        table.insert(dirs, path)
    end
end

function CpodFilter:walkTops(resYaml)
    local topDirs = listSrc(self._top)
    local dirs = system:deepcopy(resYaml.directCgPath)

    for _, top in ipairs(topDirs) do
        local top_s = pystring:join("/", {self._top, top})
        for _, filter in ipairs(resYaml.indirectCgPath) do
            local filter_s = pystring:join("/", {top_s, filter})
            local srcs = listSrc(filter_s)
            for _, src in ipairs(srcs) do
                if string.match(src, podFiler) then
                    addDirs(dirs, pystring:join("/", {filter, src}))
                    local pod_s = pystring:join("/", {filter_s, src})
                    local dockers = listSrc(pod_s)
                    for _, docker in ipairs(dockers) do
                        if string.match(docker, dockerFilter) then
                            addDirs(dirs, pystring:join("/", {filter, src, docker}))
                        end
                    end
                end
            end
        end
    end
    return dirs
end

return CpodFilter
