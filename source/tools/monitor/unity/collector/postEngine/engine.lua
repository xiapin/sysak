---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by liaozhaoyan.
--- DateTime: 2023/3/25 4:21 PM
---

require("common.class")
local CprotoData = require("common.protoData")
local postQue = require("beeQ.postQue.postQue")
local CvProto = require("collector.vproto")
local pystring = require("common.pystring")
local cjson = require("cjson.safe")

local Cengine = class("engine", CvProto)

function Cengine:_init_(que, proto_q, fYaml, tid)
    CvProto._init_(self, CprotoData.new(que))
    self._fYaml = fYaml
    self._tid = tid
end

function Cengine:proc(t, event, msgs)
    local lines = self._proto:protoTable()

    CvProto.proc(self, t)
    --local logs = pystring:split(msgs, '\n')
    local logList = {}

    logList[1] = {
        name = "post",
        log = cjson.encode(msgs)
    }
    self:appendLine(self:_packProto("post_que", nil, nil, logList))
    self:push(lines)

    local bytes = self._proto:encode(lines)
    self._proto:que(bytes)
end

function Cengine:work(t, event)
    local msgs = postQue.pull()
    if msgs then
        self:proc(t, event, msgs)
    end
end

return Cengine
