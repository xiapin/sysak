---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by liaozhaoyan.
--- DateTime: 2023/4/12 00:01
---

require("common.class")
local unistd = require("posix.unistd")
local pwait = require("posix.sys.wait")
local signal = require(" posix.signal")
local pystring = require("common.pystring")
local system = require("common.system")

local CexecBase = class("execBase")
local interval = 5   --- poll for every 5 second

function CexecBase:_init_(cmd, args, seconds)
    self._pid = 0
    self.cmd = cmd
    self._args = args
    self._cnt = 0
    self._loop = seconds / interval
end

function CexecBase:run()
    local pid, err = unistd.fork()
    assert(pid, "fork report" .. err)
    if pid > 0 then
        self._pid = pid
        self._cnt = 0
    else
        local errno
        _, err, errno = unistd.exec(self.cmd, self._args)
        assert(not errno, "exec failed." .. err .. errno)
    end
end

function CexecBase:addEvents(e)
    e:addEvent(self.cmd, self, interval, true, self._loop)
end

function CexecBase:work()
    local cnt = self._cnt
    if cnt >= self._loop then
        local pid, stat, exit = pwait.wait(self._pid, pwait.WNOHANG)
        assert(pid, "wait failed " .. stat .. exit)
        if not exit then -- process not exit
            signal.signal(self._pid, signal.SIGKILL)  -- force to kill task
            pwait.wait(self._pid)                     -- wait task
        end
    end
    self._cnt = cnt + 1
end
