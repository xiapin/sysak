---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by liaozhaoyan.
--- DateTime: 2023/3/5 12:58 PM
---

package.path = package.path .. ";../../?.lua;"
local system = require("common.system")
local dirent = require("posix.dirent")
local unistd = require("posix.unistd")
local stat = require("posix.sys.stat")
local pystring = require("common.pystring")

local srcPath = "src/"
local dstPath = "dst/"

local function listSrc(path)
    local res = {}
    local files = dirent.files(path)
    for f in files do
        if string.find(f, "%.so") then
            table.insert(res, f)
        end
    end
    return res
end

local function checkDst()
    if unistd.access(dstPath) then
        local pstat = stat.stat(dstPath)
        if stat.S_ISDIR(pstat.st_mode) == 0 then
            error(string.format("dst %s is no a dictionary", dstPath))
        end
    else
        print("mkdir " .. dstPath)
        local _, s, errno = stat.mkdir(dstPath)
        if errno then
            error(string.format("mkdir %s failed ,report %s. %d", dstPath), s, errno)
        end
    end
end

local function checkSo(fPath)
    local fSrc = srcPath .. fPath
    local fDst = dstPath .. fPath

    if unistd.access(fDst) then
        local sSrc = stat.stat(fSrc)
        local sDst = stat.stat(fDst)

        if sSrc.st_mtime > sDst.st_mtime then  -- modified
            return true
        else
            return false
        end
    else   -- exit
        return true
    end
end

local function copySo(fPath)
    local fSrc = srcPath .. fPath
    local fDst = dstPath .. fPath

    local sFile, err = io.open(fSrc,"rb")
    if err then
        error(string.format("open file %s report %s."), fSrc, err)
    end
    local stream = sFile:read("*a")
    sFile:close()

    local dFile, err = io.open(fDst,"wb")
    if err then
        error(string.format("open file %s report %s."), fDst, err)
    end
    dFile:write(stream)
    dFile:close()
end

local function checkSos()
    checkDst()
    local so_s = listSrc(srcPath)
    for _, so in ipairs(so_s) do
        if checkSo(so) then
            print("need copy " .. so)
            copySo(so)
        end
    end
end

checkSos()
