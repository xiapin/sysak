---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by liaozhaoyan.
--- DateTime: 2023/2/18 12:13 PM
---

package.path = package.path .. ";../../?.lua;"
local  dirent = require("posix.dirent")
local sysStat = require("posix.sys.stat")
local system = require("common.system")

local function join(dir, fName)
    local paths = {dir, fName}
    return table.concat(paths, "/")
end

local function walk(orig, dir, tbl)
    local ls = dirent.dir(dir)
    local len = string.len(orig)
    for _, l in ipairs(ls) do
        if l == ".." or l == '.' then
            goto continue
        end
        local path = join(dir, l)
        local stat, err, errno = sysStat.stat(path)
        if stat then
            local mode = stat.st_mode
            if sysStat.S_ISDIR(mode) > 0 then
                walk(orig, path, tbl)
            elseif sysStat.S_ISREG(mode) > 0 then
                table.insert(tbl, string.sub(path, len + 2))
            end
        else
            system:posixError(string.format("bad access to file %s", path), err, errno)
        end
        ::continue::
    end
end

local tbl = {}
local dir = "../../beaver/guide"
walk(dir, dir, tbl)
print(system:dump(tbl))
